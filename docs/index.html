<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive Sable Chum Map</title>
    <style>
      @import url("https://fonts.cdnfonts.com/css/century-schoolbook");
      body {
        margin: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        background-color: #333;
        font-family: "Century Schoolbook", serif;
        color: white;
      }

      body {
        margin: 0;
        overflow: hidden;
        display: flex; /* Add display flex to body */
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        background-color: #333;
        font-family: "Century Schoolbook", serif;
        color: white;
        height: 100vh; /* Ensure body takes full height */
      }

      #container {
        display: flex;
        flex-direction: row; /* Ensure the side panel and map are side by side */
        height: 100%;
        width: 100%;
      }

      #side-panel {
        flex: 0 0 25%; /* Maintain side panel width */
        background-color: #444;
        overflow-y: auto;
        height: 100%; /* Ensure it takes full height of its container */
        position: relative; /* Change to relative for better alignment */
        /* margin-bottom: 10px; */ /* Removed margin to prevent unwanted spacing */
        padding: 10px; /* Add padding for better spacing */
        margin-bottom: 10px; /* Add margin to separate from the map */
        z-index: 1;
        scrollbar-width: none;
      }

      #map-container {
        flex: 1; /* Allow it to take the remaining space */
        overflow: hidden;
        cursor: grab;
        height: 100%; /* Ensure it takes full height of its container */
      }

      #reset-btn {
        font-size: 18px;
        font-family: inherit;
        padding: 5px;
        background-color: #555;
        border: 1px solid #666;
        color: inherit;
      }

      #reset-btn:hover {
        background-color: #777;
      }

      #counter {
        font-size: 24px;
        text-align: center;
        margin: inherit;
        padding: inherit;
      }

      .region {
        margin-bottom: inherit;
      }

      .region-header {
        cursor: pointer;
        padding: 5px;
        background-color: #555;
        border: 1px solid #666;
      }

      .region-content {
        display: none;
        padding: 5px;
        background-color: #666;
        border: 1px solid #777;
      }

      .chum-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }

      .chum-item input {
        margin-right: 10px;
      }

      .highlight {
        animation: highlight 1s infinite alternate;
      }

      @keyframes highlight {
        from {
          filter: brightness(1);
        }
        to {
          filter: brightness(2);
        }
      }

      #map {
        display: block;
        transform-origin: top left;
        user-select: none;
        -webkit-user-drag: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      .collectible {
        position: absolute;
        fill: currentColor;
        stroke: currentColor;
        width: 50px;
        height: 32px;
        left: 0px;
        top: 0px;
      }

      .collected {
        filter: grayscale(100%) brightness(0.67);
      }

      .collectible:hover {
        cursor: pointer;
        filter: drop-shadow(0 0 5px #cccc33) drop-shadow(0 0 10px #cccc33);
      }

      .collected:hover {
        filter: drop-shadow(0px 0px 5px white) drop-shadow(0px 0px 10px white)
          drop-shadow(0px 0px 15px white) grayscale(100%) brightness(0.67);
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="side-panel">
        <button id="reset-btn">Reset View</button>
        <div id="counter">0/165</div>
      </div>
      <div id="map-container">
        <img
          id="map"
          src="Sable-Chum-Map-90.webp"
          alt="Game Map"
          draggable="false"
          loading="lazy"
        />
      </div>
    </div>
    <script>
      const collectibles = [];

      const mapContainer = document.getElementById("map-container");
      const map = document.getElementById("map");
      const counter = document.getElementById("counter");
      const reset = document.getElementById("reset-btn");
      const sidePanel = document.getElementById("side-panel");

      let scale = 1;
      let originX = 0;
      let originY = 0;
      let isDragging = false;
      let startX = 0;
      let startY = 0;
      let wasDragging = false;

      function updateTransform() {
        map.style.transform = `translate(${originX}px, ${originY}px) scale(${scale})`;
        const offset = mapContainer.getBoundingClientRect().left;

        document.querySelectorAll(".collectible").forEach((marker, index) => {
          const coord = collectibles[index];

          const transformedX = offset + (coord.x - 6) * scale + originX - 25;
          const transformedY = (coord.y + 5) * scale + originY - 16;

          const markerScale = Math.max(scale, 32 / marker.offsetWidth);

          marker.style.transform = `translate(${transformedX}px, ${transformedY}px) scale(${markerScale})`;
        });

        saveStateToLocalStorage();
      }

      function saveStateToLocalStorage() {
        const state = {
          scale,
          originX,
          originY,
        };
        localStorage.setItem("mapState", JSON.stringify(state));
      }

      function loadStateFromLocalStorage() {
        const savedState = JSON.parse(localStorage.getItem("mapState"));
        if (savedState) {
          scale = savedState.scale;
          originX = savedState.originX;
          originY = savedState.originY;
        } else {
          fitMapToContainer();
        }
      }

      function fitMapToContainer() {
        const containerRect = mapContainer.getBoundingClientRect();
        const naturalWidth = map.naturalWidth;
        const naturalHeight = map.naturalHeight;

        const scaleX = containerRect.width / naturalWidth;
        const scaleY = containerRect.height / naturalHeight;

        scale = Math.min(scaleX, scaleY);

        originX = (containerRect.width - naturalWidth * scale) / 2;
        originY = (containerRect.height - naturalHeight * scale) / 2;
      }

      function loadCollectibles() {
        const collected = JSON.parse(localStorage.getItem("collected") || "[]");

        collectibles.forEach((coord, index) => {
          const featherImg = document.createElement("img");
          featherImg.classList.add("collectible");
          featherImg.src = "feather.svg";
          featherImg.draggable = false;

          if (collected.includes(index)) {
            featherImg.classList.add("collected");
          }

          featherImg.addEventListener("click", () => {
            toggleCollectible(index, featherImg); // Ensure the marker toggles the checkbox
          });

          mapContainer.appendChild(featherImg);
        });

        updateCounter();
      }
      function updateRegionCounter(regionIndex, regionHeader, collected) {
        const regionCollectibles = collectibles.filter(
          (chum) => chum.regionIndex === regionIndex,
        );
        const collectedInRegion = regionCollectibles.filter((chum) =>
          collected.includes(chum.index),
        );

        // Extract the region name (before the first number in the header text)
        const headerText = regionHeader.textContent;
        const regionName = headerText.replace(/\d+\/\d+$/, "").trim();

        // Update the header with the region name and the new collectible count
        regionHeader.textContent = `${regionName} ${collectedInRegion.length}/${regionCollectibles.length}`;
      }

      function toggleCollectible(index, featherImg, toggleCheckbox = true) {
        if (!wasDragging) {
          let collected = JSON.parse(localStorage.getItem("collected") || "[]");

          const checkbox = document.querySelector(
            `#chum-${index} input[type="checkbox"]`,
          );
          const regionHeader =
            document.querySelectorAll(".region-header")[
              collectibles[index].regionIndex
            ];

          // Toggle the collected status
          if (collected.includes(index)) {
            collected = collected.filter((i) => i !== index);
            featherImg.classList.remove("collected");

            if (toggleCheckbox) checkbox.checked = false; // Uncheck the checkbox
          } else {
            collected.push(index);
            featherImg.classList.add("collected");

            if (toggleCheckbox) checkbox.checked = true; // Check the checkbox
          }

          // Save the updated collected state
          localStorage.setItem("collected", JSON.stringify(collected));

          // Update region and total counters
          updateRegionCounter(
            collectibles[index].regionIndex,
            regionHeader,
            collected,
          );
          updateCounter();
        }
      }

      function updateCounter() {
        const collected = JSON.parse(localStorage.getItem("collected") || "[]");
        counter.textContent = `${collected.length}/${collectibles.length}`;
      }

      function populateSidePanel() {
        const regions = {};

        // Group collectibles by region
        collectibles.forEach((chum, index) => {
          if (!regions[chum.region]) {
            regions[chum.region] = [];
          }
          chum.index = index; // Add index to the collectible for reference
          regions[chum.region].push(index);
        });

        // Sort regions alphabetically
        const sortedRegionNames = Object.keys(regions).sort();

        sortedRegionNames.forEach((region, regionIndex) => {
          const regionDiv = document.createElement("div");
          regionDiv.classList.add("region");

          const regionHeader = document.createElement("div");
          regionHeader.classList.add("region-header");
          regionHeader.textContent = `${region} 0/${regions[region].length}`;
          regionHeader.addEventListener("click", () => {
            const content = regionDiv.querySelector(".region-content");
            content.style.display =
              content.style.display === "none" ? "block" : "none";
          });

          const regionContent = document.createElement("div");
          regionContent.classList.add("region-content");
          regionContent.style.display = "none";

          regions[region].forEach((index) => {
            const chumItem = document.createElement("div");
            chumItem.classList.add("chum-item");
            chumItem.id = `chum-${index}`;

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = JSON.parse(
              localStorage.getItem("collected") || "[]",
            ).includes(index);
            checkbox.addEventListener("change", () => {
              toggleCollectible(
                index,
                document.querySelectorAll(".collectible")[index],
                false,
              );
            });

            const chumLabel = document.createElement("label");
            chumLabel.textContent = `Chum ${index + 1}`;
            chumLabel.addEventListener("click", () => {
              document
                .querySelectorAll(".collectible")
                .forEach((marker) => marker.classList.remove("highlight"));
              document
                .querySelectorAll(".collectible")
                [index].classList.add("highlight");
            });

            chumItem.appendChild(checkbox);
            chumItem.appendChild(chumLabel);
            regionContent.appendChild(chumItem);
          });

          regionDiv.appendChild(regionHeader);
          regionDiv.appendChild(regionContent);
          sidePanel.appendChild(regionDiv);

          // Update regionIndex to track the sorted order for updating later
          regions[region].forEach((index) => {
            collectibles[index].regionIndex = regionIndex;
          });

          // Update the region counter initially
          updateRegionCounter(
            regionIndex,
            regionHeader,
            JSON.parse(localStorage.getItem("collected") || "[]"),
          );
        });
      }

      map.addEventListener("dragstart", (event) => event.preventDefault());

      mapContainer.addEventListener("wheel", (event) => {
        event.preventDefault();

        const rect = map.getBoundingClientRect();
        const mouseX = (event.clientX - rect.left) / scale;
        const mouseY = (event.clientY - rect.top) / scale;

        const zoomFactor = event.deltaY > 0 ? 0.9 : 1.1;
        const newScale = scale * zoomFactor;

        originX = mouseX * (scale - newScale) + originX;
        originY = mouseY * (scale - newScale) + originY;

        scale = newScale;

        updateTransform();
      });

      mapContainer.addEventListener("mousedown", (event) => {
        isDragging = true;
        wasDragging = false;
        startX = event.clientX - originX;
        startY = event.clientY - originY;
        mapContainer.style.cursor = "grabbing";
      });

      mapContainer.addEventListener("mousemove", (event) => {
        if (isDragging) {
          originX = event.clientX - startX;
          originY = event.clientY - startY;
          updateTransform();
          wasDragging = true;
        }
      });

      mapContainer.addEventListener("mouseup", () => {
        isDragging = false;
        mapContainer.style.cursor = "grab";
      });

      mapContainer.addEventListener("mouseleave", () => {
        isDragging = false;
        mapContainer.style.cursor = "grab";
      });

      counter.addEventListener("click", () => {
        fitMapToContainer();
        updateTransform();
      });

      reset.addEventListener("click", () => {
        fitMapToContainer();
        updateTransform();
      });

      // window.addEventListener("resize", fitMapToContainer);
      window.addEventListener("load", () => {
        loadStateFromLocalStorage();
        fetch("chums.json")
          .then((response) => response.json())
          .then((data) => {
            collectibles.push(...data);
            loadCollectibles();
            populateSidePanel();
            updateTransform();
          });
      });
    </script>
  </body>
</html>
